Конечно! Ниже — полные и профессионально оформленные ответы на все части тестового задания, как от QA-специалиста с 10-летним опытом.

---

## **1. API и Архитектура (Анализ логов)**

### **1. Какая критическая проблема здесь произошла? (Опишите результат для баланса пользователя).**

Произошло **двойное списание средств**.  
Сервер обработал два идентичных запроса на перевод как два независимых действия, несмотря на то, что второй — результат автоматического повтора (retry) из-за потери ответа.  

Результат:
- Счет пользователя **101** уменьшился на **200** (100 × 2),
- Счет пользователя **202** увеличился на **200**,
- Хотя пользователь намеревался перевести **только 100**.

Это нарушение **идемпотентности** операции и приводит к **финансовой ошибке**, которую крайне сложно откатить без ручного вмешательства.

---

### **2. Какой архитектурный механизм (назовите термин) должен быть реализован на бэкенде, чтобы защита от таких ситуаций работала автоматически?**

Необходимо реализовать **идемпотентность запросов** на уровне API.  
Конкретный механизм — **идемпотентные ключи (Idempotency Keys)**.

Это позволяет серверу распознавать повторные запросы с тем же ключом и возвращать результат первого выполненного запроса, не выполняя операцию повторно.

---

### **3. Что нужно добавить в заголовки или тело запроса, чтобы этот механизм заработал?**

Клиент должен генерировать **уникальный идемпотентный ключ** для каждой бизнес-операции (например, UUID) и передавать его в заголовке, например:

```
Idempotency-Key: a1b2c3d4-e5f6-7890-g1h2-i3j4k5l6m7n8
```

Сервер сохраняет этот ключ вместе с результатом операции и при повторном запросе с тем же ключом возвращает кэшированный ответ, не модифицируя состояние системы.

---

## **2. Траблшутинг (Root Cause Analysis)**

### **1. В чем истинная причина ошибки?**

Истинная причина — **отсутствие прав доступа у серверного приложения к бакету S3**.  
Ошибка `AccessDenied` при вызове `PutObject` указывает на проблему с **IAM-ролями/политиками AWS**: бэкенд не имеет разрешения на запись в бакет `avatars`.

Это **не баг в коде**, **не ошибка фронтенда**, и **не падение базы данных**, а **ошибка конфигурации инфраструктуры**.

---

### **2. На кого вы назначите этот баг? Почему?**

**Назначаю: DevOps** (или облачный/SRE-инженер, отвечающий за инфраструктуру AWS).

**Почему?**  
Код корректно вызывает `put_object`, но получает ошибку на уровне API AWS. Это означает, что учетные данные или роль, под которой работает сервис, не имеют необходимых разрешений (`s3:PutObject`) на целевой бакет.  
Исправление требует обновления IAM-политик или настройки бакета — задача DevOps, а не разработчиков приложения.

---

## **3. Тест-дизайн (Security & Logic)**

### **Задание: Написать 2 проверки на безопасность при редактировании профиля**

#### **Проверка 1: Попытка изменения данных другого пользователя**
- **Что меняем**: в теле запроса меняем `"user_id": 100` → `"user_id": 101` (ID другого пользователя).
- **Ожидаемое поведение**: сервер **отклоняет запрос** с ошибкой `403 Forbidden` или `400 Bad Request`, так как пользователь с ID 100 не имеет права редактировать профиль пользователя 101.
- **Цель**: проверить защиту от **horizontal privilege escalation**.

#### **Проверка 2: Попытка повышения своей роли**
- **Что меняем**: в теле запроса меняем `"role": "user"` → `"role": "admin"`.
- **Ожидаемое поведение**: сервер **игнорирует поле `role`** или возвращает ошибку `403 Forbidden`. Роль не должна обновляться через этот endpoint обычным пользователям.
- **Цель**: проверить защиту от **vertical privilege escalation**.

---

## **Баг-репорты и приоритеты**

### **Баг 1: Отсутствие идемпотентности при денежных переводах**
- **Title**: Financial transaction is not idempotent — duplicate requests cause double transfer  
- **Steps to Reproduce**:  
  1. Отправить POST /api/transfer с корректными данными.  
  2. Сымитировать потерю ответа (например, через прокси или network throttling).  
  3. Приложение повторяет запрос автоматически.  
  4. Наблюдать два успешных ответа с разными `tx_id`.  
- **Actual Result**: Деньги списаны дважды.  
- **Expected Result**: Второй запрос возвращает результат первого (без повторного списания).  
- **Severity / Priority**: **Critical / P0** — прямой финансовый ущерб.

---

### **Баг 2: Доступ к S3 запрещён при загрузке аватара**
- **Title**: File upload fails with "AccessDenied" due to missing S3 permissions  
- **Steps to Reproduce**:  
  1. Авторизоваться в приложении.  
  2. Попытаться загрузить аватар.  
  3. Наблюдать ошибку на фронтенде.  
  4. В логах — `AccessDenied` при вызове `PutObject` в S3.  
- **Actual Result**: Загрузка невозможна.  
- **Expected Result**: Файл успешно сохраняется в S3.  
- **Severity / Priority**: **High / P1** — функциональность недоступна, но финансового риска нет.

---

### **Баг 3: Возможность редактировать чужой профиль (Insecure Direct Object Reference)**
- **Title**: User can modify another user’s profile via PUT /api/users/update by changing user_id  
- **Steps to Reproduce**:  
  1. Авторизоваться как user_id=100.  
  2. Отправить PUT /api/users/update с телом: `{"user_id": 101, "email": "hacked@test.com"}`.  
  3. Проверить профиль пользователя 101.  
- **Actual Result**: Email пользователя 101 изменён.  
- **Expected Result**: Запрос отклонён с 403.  
- **Severity / Priority**: **Critical / P0** — нарушение конфиденциальности и целостности данных.

---

### **Баг 4: Возможность сменить роль на admin через API**
- **Title**: User can escalate privileges by setting "role": "admin" in profile update  
- **Steps to Reproduce**:  
  1. Авторизоваться как обычный пользователь.  
  2. Отправить PUT /api/users/update с `"role": "admin"`.  
  3. Проверить свои права после обновления.  
- **Actual Result**: Роль изменена на admin.  
- **Expected Result**: Поле `role` игнорируется или возвращается ошибка.  
- **Severity / Priority**: **Critical / P0** — прямой путь к компрометации системы.

---

Если потребуется — могу подготовить эти баг-репорты в формате Jira или шаблоне компании.
